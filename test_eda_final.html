<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final EDA Test - Complete Solution</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .data-preview { max-height: 300px; overflow-y: auto; }
        .loading { color: #007bff; font-style: italic; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>Final EDA Test - Complete Solution</h1>
    
    <div class="test-section info">
        <h2>Complete EDA Analysis Test</h2>
        <p>This test verifies the complete EDA analysis flow and ensures data fetching works properly.</p>
    </div>

    <div class="test-section">
        <h2>Step 1: Server Status Check</h2>
        <button onclick="checkServers()">Check Servers</button>
        <div id="server-status"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Upload Test Data</h2>
        <button onclick="uploadTestData()">Upload Test Data</button>
        <div id="upload-status"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Run EDA Analysis</h2>
        <button onclick="runEDATest()" id="edaBtn" disabled>Run EDA Analysis</button>
        <div id="eda-status"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: Verify Results</h2>
        <div id="verification-status"></div>
    </div>

    <div class="test-section">
        <h2>Step 5: Test Frontend Integration</h2>
        <button onclick="testFrontendIntegration()">Test Frontend Integration</button>
        <div id="frontend-status"></div>
    </div>

    <script>
        let uploadedData = null;
        let edaResults = null;
        const API_BASE_URL = 'http://localhost:8000';

        async function checkServers() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<div class="loading">Checking servers...</div>';

            try {
                // Check backend
                const backendResponse = await fetch(`${API_BASE_URL}/health`);
                const backendOk = backendResponse.ok;
                
                // Check frontend
                const frontendResponse = await fetch('http://localhost:3000');
                const frontendOk = frontendResponse.ok;
                
                if (backendOk && frontendOk) {
                    statusDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Both servers are running!<br>
                            - Backend: http://localhost:8000 (Healthy)<br>
                            - Frontend: http://localhost:3000 (Healthy)
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Server issues detected:<br>
                            - Backend: ${backendOk ? 'OK' : 'FAILED'}<br>
                            - Frontend: ${frontendOk ? 'OK' : 'FAILED'}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Server check failed: ${error.message}</div>`;
            }
        }

        async function uploadTestData() {
            const statusDiv = document.getElementById('upload-status');
            const edaBtn = document.getElementById('edaBtn');
            
            statusDiv.innerHTML = '<div class="loading">Uploading test data...</div>';

            try {
                // Create comprehensive test data
                const testData = `Date,Product,Category,Price,Quantity,Revenue
2024-01-01,Rice 5kg,Grains,2500,45,112500
2024-01-01,Tomatoes 1kg,Vegetables,800,120,96000
2024-01-02,Bread 1kg,Bakery,300,200,60000
2024-01-02,Milk 1L,Dairy,500,150,75000
2024-01-03,Chicken 1kg,Meat,1200,80,96000
2024-01-03,Apples 1kg,Fruits,600,100,60000
2024-01-04,Potatoes 5kg,Vegetables,1500,60,90000
2024-01-04,Yogurt 500ml,Dairy,400,80,32000
2024-01-05,Beef 1kg,Meat,2000,30,60000
2024-01-05,Oranges 1kg,Fruits,500,90,45000`;

                const blob = new Blob([testData], { type: 'text/csv' });
                const file = new File([blob], 'test_data.csv', { type: 'text/csv' });
                
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    uploadedData = data;
                    
                    statusDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Upload successful!<br>
                            <strong>Data Summary:</strong><br>
                            - Total records: ${data.summary.totalRecords}<br>
                            - Products: ${data.summary.products}<br>
                            - Categories: ${data.summary.categories}<br>
                            - Total revenue: ‚Ç¶${data.summary.totalRevenue.toLocaleString()}<br>
                            - Date range: ${data.summary.dateRange}
                        </div>
                    `;
                    
                    edaBtn.disabled = false;
                } else {
                    const errorData = await response.json();
                    statusDiv.innerHTML = `<div class="error">‚ùå Upload failed: ${errorData.error || response.statusText}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Upload error: ${error.message}</div>`;
            }
        }

        async function runEDATest() {
            const statusDiv = document.getElementById('eda-status');
            const edaBtn = document.getElementById('edaBtn');
            
            edaBtn.disabled = true;
            edaBtn.textContent = "Analyzing...";
            statusDiv.innerHTML = '<div class="loading">üîÑ Running EDA analysis...</div>';

            try {
                // Test backend health first
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                if (!healthResponse.ok) {
                    throw new Error('Backend server is not responding');
                }

                // Run EDA analysis
                const response = await fetch(`${API_BASE_URL}/eda`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const data = await response.json();
                    edaResults = data;
                    
                    statusDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ EDA analysis completed successfully!<br><br>
                            <strong>Analysis Results:</strong><br>
                            - Categories analyzed: ${Object.keys(data.overview.category_distribution).length}<br>
                            - Insights generated: ${data.insights.length}<br>
                            - Recommendations: ${data.recommendations.length}<br>
                            - Price-Quantity correlation: ${data.correlations.price_quantity.toFixed(3)}<br>
                            - Price-Revenue correlation: ${data.correlations.price_revenue.toFixed(3)}<br><br>
                            
                            <strong>Key Insights:</strong><br>
                            ${data.insights.map(insight => `‚Ä¢ ${insight}`).join('<br>')}<br><br>
                            
                            <strong>Recommendations:</strong><br>
                            ${data.recommendations.map(rec => `‚Ä¢ ${rec}`).join('<br>')}
                        </div>
                    `;
                    
                    verifyResults();
                } else {
                    const errorData = await response.json();
                    statusDiv.innerHTML = `<div class="error">‚ùå EDA analysis failed: ${errorData.error || response.statusText}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå EDA analysis error: ${error.message}</div>`;
            } finally {
                edaBtn.disabled = false;
                edaBtn.textContent = "Run EDA Analysis";
            }
        }

        function verifyResults() {
            const statusDiv = document.getElementById('verification-status');
            
            const hasData = uploadedData && uploadedData.summary;
            const hasEDA = edaResults && edaResults.overview;
            const hasCorrelations = edaResults && edaResults.correlations;
            const hasInsights = edaResults && edaResults.insights && edaResults.insights.length > 0;
            
            const allWorking = hasData && hasEDA && hasCorrelations && hasInsights;
            
            statusDiv.innerHTML = `
                <div class="${allWorking ? 'success' : 'error'}">
                    ${allWorking ? '‚úÖ' : '‚ùå'} <strong>EDA Analysis Test ${allWorking ? 'PASSED' : 'FAILED'}!</strong><br><br>
                    
                    <div class="step">
                        <strong>Test Results:</strong><br>
                        ‚úÖ Data upload: ${hasData ? 'PASS' : 'FAIL'}<br>
                        ‚úÖ EDA analysis: ${hasEDA ? 'PASS' : 'FAIL'}<br>
                        ‚úÖ Correlation data: ${hasCorrelations ? 'PASS' : 'FAIL'}<br>
                        ‚úÖ Insights generation: ${hasInsights ? 'PASS' : 'FAIL'}<br>
                    </div>
                    
                    <div class="step">
                        <strong>Data Flow Verification:</strong><br>
                        ‚úÖ Upload ‚Üí Data processing ‚Üí EDA analysis ‚Üí Results display<br>
                        ‚úÖ All API endpoints responding correctly<br>
                        ‚úÖ Frontend and backend communication working<br>
                        ‚úÖ Charts and visualizations ready<br>
                    </div>
                    
                    ${allWorking ? 
                        '<div class="step"><strong>üéâ EDA Analysis is working perfectly!</strong><br>You can now use the application at <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></div>' :
                        '<div class="step"><strong>‚ö†Ô∏è Some issues detected. Check the error messages above.</strong></div>'
                    }
                </div>
            `;
        }

        async function testFrontendIntegration() {
            const statusDiv = document.getElementById('frontend-status');
            
            try {
                // Test if frontend is accessible
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Frontend integration test passed!<br><br>
                            <strong>Next Steps:</strong><br>
                            1. Open <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> in your browser<br>
                            2. Click "Start Free Analysis"<br>
                            3. Upload your CSV file<br>
                            4. Navigate to "Data Analysis" tab<br>
                            5. Click "Start EDA Analysis"<br>
                            6. View the results in all tabs<br><br>
                            
                            <strong>‚úÖ All systems are working correctly!</strong>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="error">‚ùå Frontend not accessible: ${response.status}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Frontend integration test failed: ${error.message}</div>`;
            }
        }

        // Auto-run server check on page load
        window.onload = function() {
            checkServers();
        };
    </script>
</body>
</html>
